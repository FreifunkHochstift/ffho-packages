#!/bin/sh

local=false
while getopts l opt
do
	case $opt in
		l)
			local=true;;
	esac
done

if ! $local ; then
	export tf="$(mktemp -t ffpb-debug.XXXXXX)"
	exec 3>&2 >"$tf" 2>&1
fi

sysinfo() {
	echo -en "Hostname = "
	uname -n
	echo -en "Gluon Release = "
	cat /lib/gluon/release
	echo -en "Uptime = "
	uptime
	echo -en "Timestamp = "
	date
}

cmd() {
        echo "--- START $* ---"
        "$@"
        echo "--- END ($?) $* ---"
        echo
}

cmd sysinfo
cmd ip addr show
cmd ip route show
cmd iw phy phy0 info
cmd iw dev wlan0 info
cmd iw dev wlan0 station dump
cmd iw dev wlan0-1 station dump
cmd batctl gwl
cmd batctl tl
killall -USR1 fastd 2>/dev/null
cmd logread

if $local ; then
	echo "No information has been sent to the ffpb-team."
else
	exec >&3 2>&1

	echo "Sending report (stored in $tf) to ffpb-team ..."
	HOST=$(lua -e 'print(require("gluon.site_config").debugserver.host)')
	PORT=$(lua -e 'print(require("gluon.site_config").debugserver.port)')
	code=`gzip -c $tf | nc $HOST $PORT`
	if [ $? -eq 0 ]; then
		echo "Report-ID: $code"
	else
		echo "Failed to send report :( but storing the file and sending it later \o/"
		mkdir -p /var/cache/ff/debug
		gzip -c "$tf" > /var/cache/ff/debug/stored.ff-debug.gz
	fi
	#TODO: rm "$tf"
fi

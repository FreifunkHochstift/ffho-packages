#!/bin/sh

local=false
while getopts l opt
do
	case $opt in
		l)
			local=true;;
	esac
done

if ! $local ; then
	export tf="$(mktemp -t ffpb-debug.XXXXXX)"
	exec 3>&2 >"$tf" 2>&1
fi

sysinfo() {
	echo -en "Hostname = "
	uname -n
	echo -en "Gluon Release = "
	cat /lib/gluon/release
	echo -en "Uptime = "
	uptime
	echo -en "Timestamp = "
	date
}

cmd() {
        echo "--- START $* ---"
        "$@"
        echo "--- END ($?) $* ---"
        echo
}

cmd sysinfo
cmd ip addr show
cmd ip route show
cmd iw phy
cmd iw dev wlan0 info
cmd iw dev wlan0 station dump
cmd batctl gwl

if $local ; then
	echo "I will not send any information to ffpb-team"    >&3
else
	echo "Sending report to ffpb-team"                     >&3
	code="$(nc debug.paderborn.freifunk.net 1337 < "$tf")" >&3
	echo "Report number: $code"                            >&3
	#TODO: rm "$tf"
fi

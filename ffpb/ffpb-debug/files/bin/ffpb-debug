#!/bin/sh                                                           

export tf=`mktemp`                                                  
                                                                    
echo "--- START sysinfo ---" >>$tf                                  
echo -en "Hostname = " >> $tf                                       
uname -n >> $tf                                                     
echo -en "Gluon Release = " >> $tf                                  
cat /lib/gluon/release >> $tf                                       
echo -en "Uptime = " >> $tf                                         
uptime >> $tf                                                       
echo -en "Timestamp = " >> $tf                                      
date >> $tf                                                         
echo "--- END sysinfo ---\n" >>$tf                                  
echo >> $tf                                                         
                                                                    
cmd() {                                                             
        echo "--- START $* ---" >> $tf                              
        $* 2>&1 >> $tf                                              
        echo "--- END ($?) $* ---" >> $tf                           
        echo >> $tf                                                 
}                                                                   
                                                                    
cmd ip addr show                                                    
cmd ip route show                                                   
cmd iw phy phy0 info
cmd iw dev wlan0 info                                               
cmd iw dev wlan0 station dump                                       
cmd batctl gwl                                                      
cmd logread

local=false
while getopts l opt
do
	case $opt in
		l)
			local=true;;
	esac
done

echo "Report stored in: $tf"
if $local ; then
	echo "No information has been sent to the ffpb-team."
else
	echo "Sending report to ffpb-team ..."
	code=`gzip -c $tf | nc debugreport.paderborn.freifunk.net 1337`
	if [ $? -eq 0 ]; then
		echo "Report number: "
		echo $code
	else
		echo "Failed to send report :("
	fi
fi
